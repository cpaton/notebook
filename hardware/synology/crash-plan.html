<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CrashPlan</title>
    <link rel="canonical" href="https://notebook.craigpaton.uk/hardware/synology/crash-plan.html" />
    <!--<link rel="stylesheet" type="text/css" href="/css/bootstrap.css" media="screen">-->
    <link rel="stylesheet" type="text/css" href="/css/bootstrap-solar.min.css" media="screen">
    <link rel="stylesheet" type="text/css" href="/css/bootstrap-toc.min.css" media="screen">
    <link rel="stylesheet" type="text/css" href="/css/rainbow.css" media="screen">
    <link rel="stylesheet" type="text/css" href="/css/customisation.css" media="screen">
</head>
<body data-spy="scroll" data-target="#toc">
    <nav id="header-nav-bar" class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">Notebook</a>
            </div>
            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">development <span class="caret"></span></a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">architecture</a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/development/architecture/CQRS.html">CQRS</a></li>
                            <li class=""><a href="/development/architecture/DDD.html">DDD</a></li>
                            <li class=""><a href="/development/architecture/event-sourcing.html">Event Sourcing</a></li>
                            <li class=""><a href="/development/architecture/resources.html">Resources</a></li>
                            </ul>
                            <!-- NavBarMenu Start --> 
                            </li>   
                            <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">computer-science</a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/development/computer-science/compilers-and-interpreters.html">Compilers &amp; Interpreters</a></li>
                            </ul>
                            <!-- NavBarMenu Start --> 
                            </li>   
                            <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">fsharp</a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/development/fsharp/resources.html">Resources</a></li>
                            </ul>
                            <!-- NavBarMenu Start --> 
                            </li>   
                            <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">git</a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/development/git/ssh-keys.html">SSH Key Generation</a></li>
                            <li class=""><a href="/development/git/ssh-key-per-host.html">SSH Key Per Host</a></li>
                            </ul>
                            <!-- NavBarMenu Start --> 
                            </li>   
                            <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">powershell</a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/development/powershell/dynamic-functions.html">Dynamic Functions</a></li>
                            <li class=""><a href="/development/powershell/passwords.html">Passwords</a></li>
                            <li class=""><a href="/development/powershell/publishing-modules.html">Publising Modules</a></li>
                            <li class=""><a href="/development/powershell/updating-modules.html">Updating Modules</a></li>
                            </ul>
                            <!-- NavBarMenu Start --> 
                            </li>   
                            <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">process</a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/development/process/dev-ops.html">DevOps</a></li>
                            <li class=""><a href="/development/process/kanban.html">Kanban</a></li>
                            <li class=""><a href="/development/process/ToC.html">Theory of Constraints</a></li>
                            </ul>
                            <!-- NavBarMenu Start --> 
                            </li>   
                            <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">testing</a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/development/testing/BDD.html">BDD</a></li>
                            <li class=""><a href="/development/testing/current-thinking.html">Current thinking</a></li>
                            <li class=""><a href="/development/testing/resources.html">Resources</a></li>
                            </ul>
                            <!-- NavBarMenu Start --> 
                            </li>   
                            <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">tooling</a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/development/tooling/tfs.html">TFS</a></li>
                            </ul>
                            <!-- NavBarMenu Start --> 
                            </li>   
                            <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">web</a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/development/web/angular.html">Angular 2</a></li>
                            <li class=""><a href="/development/web/npm.html">NPM</a></li>
                            <li class=""><a href="/development/web/resources.html">Resources</a></li>
                            </ul>
                            <!-- NavBarMenu Start --> 
                            </li>   
                            </ul>
                            <!-- NavBarMenu Start --> 
                    </li>
                </ul>
                <ul class="nav navbar-nav">
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">hardware <span class="caret"></span></a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/hardware/network-speed.html">Network Speed</a></li>
                            <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">raspberry-pi</a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/hardware/raspberry-pi/sd-cards.html">SD Cards</a></li>
                            </ul>
                            <!-- NavBarMenu Start --> 
                            </li>   
                            <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">synology</a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/hardware/synology/crash-plan.html">CrashPlan</a></li>
                            <li class=""><a href="/hardware/synology/git.html">Git Backup</a></li>
                            <li class=""><a href="/hardware/synology/gmvault.html">GMail Backup (GMVault)</a></li>
                            <li class=""><a href="/hardware/synology/notifications.html">Notifications</a></li>
                            <li class=""><a href="/hardware/synology/plex.html">Plex</a></li>
                            <li class=""><a href="/hardware/synology/restore.html">Restore Plan</a></li>
                            <li class=""><a href="/hardware/synology/ssh.html">SSH</a></li>
                            <li class=""><a href="/hardware/synology/vpn.html">VPN</a></li>
                            </ul>
                            <!-- NavBarMenu Start --> 
                            </li>   
                            <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">unifi</a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/hardware/unifi/vpn.html">VPN</a></li>
                            </ul>
                            <!-- NavBarMenu Start --> 
                            </li>   
                            </ul>
                            <!-- NavBarMenu Start --> 
                    </li>
                </ul>
                <ul class="nav navbar-nav">
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">misc <span class="caret"></span></a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">learning</a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/misc/learning/resources.html">Resources</a></li>
                            </ul>
                            <!-- NavBarMenu Start --> 
                            </li>   
                            <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">utility</a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/misc/utility/video.html">Video</a></li>
                            </ul>
                            <!-- NavBarMenu Start --> 
                            </li>   
                            </ul>
                            <!-- NavBarMenu Start --> 
                    </li>
                </ul>
                <ul class="nav navbar-nav">
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">ops <span class="caret"></span></a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/ops/machine-bootsrap.html">Machine Bootstrap</a></li>
                            <li class=""><a href="/ops/resources.html">Resources</a></li>
                            <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">docker</a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/ops/docker/cheat-sheet.html">Cheat Sheet</a></li>
                            <li class=""><a href="/ops/docker/on-windows.html">Docker On Windows</a></li>
                            <li class=""><a href="/ops/docker/map-custom_folder-to-host.html">Map Custom Folder</a></li>
                            </ul>
                            <!-- NavBarMenu Start --> 
                            </li>   
                            <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">linux</a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/ops/linux/arch-linux.html">Arch Linux Install</a></li>
                            </ul>
                            <!-- NavBarMenu Start --> 
                            </li>   
                            </ul>
                            <!-- NavBarMenu Start --> 
                    </li>
                </ul>
            </div>
        </div>
    </nav>

<div class="container">

    <div class="row">
        <div class="col-md-9">
            <h1>CrashPlan</h1>
            <hr />
        <p>CrashPlan consists of two parts, a server and a client that connects to the server for configuration and monitoring. On a NAS device you install just the server in what is called headless mode. Follow the instructions from</p>
<ul>
<li><a href="http://www.hanselman.com/blog/UPDATED2014HowToSetupCrashPlanCloudBackupOnASynologyNASRunningDSM50.aspx">Hanselman</a></li>
<li><a href="http://pcloadletter.co.uk/2012/01/30/crashplan-syno-package/">PC Load Letter</a></li>
<li><a href="https://miketabor.com/install-crashplan-synology/">Mike Tabor</a> - slighty more up to date than PC load letter</li>
</ul>
<p>Essentially</p>
<ul>
<li>Install Java</li>
<li>Enable home service on the NAS</li>
<li>Install the CrashPlan package from PCLoadLetter</li>
<li>Setup client on a PC to connect to the server running on the NAS and configure it</li>
</ul>
<h1 id="docker">Docker</h1>
<p>Information:</p>
<ul>
<li><a href="https://miketabor.com/run-crashplan-docker-synology-nas/">Mike Tabor</a></li>
<li><a href="https://github.com/JrCs/docker-crashplan">Dockerfile</a></li>
</ul>
<p>When the container is running you can open a terminal from within the synology UI to get the guid you need to connect to the server from the windows server</p>
<pre><code class="language-bash">cat /var/lib/crashplan/.ui_info
</code></pre>
<p>Volume mounts are setup as</p>
<p>File/Folder: /Data
Mount Path: /volume1/Data</p>
<p>Think this had to be setup from the command line once and could not be setup from the synology UI directly.  Wasn't able to mount the root of the volume as per the instructions and had to use subfolders.</p>
<h1 id="windows-client">Windows Client</h1>
<p>Two items need to be configured to use the windows client to connect to the Synology daemon</p>
<ul>
<li><strong>C:\Program Files\CrashPlan\conf\ui.properties</strong> need to update serviceHost to the IP address of the Synology</li>
<li>Copy the file <strong>/var/lib/crashplan/.ui_info</strong> from the Synology to <strong>C:\ProgramData\CrashPlan\.ui_info</strong> (this file includes a port number and a GUID). The last part is the IP address of the Synology device this should be updated</li>
</ul>
<h1 id="fails-to-start">Fails to start</h1>
<h2 id="installing-upgrade-then-stops-4.7.0">Installing upgrade then stops &gt;= 4.7.0</h2>
<pre>
I 10/01/16 11:05AM CrashPlan started, version 4.7.0, GUID 674279968953860117
I 10/01/16 11:05AM Downloading a new version of CrashPlan.
I 10/01/16 11:05AM Download of upgrade complete - version 1435813200480.
I 10/01/16 11:05AM Installing upgrade - version 1435813200480
I 10/01/16 11:05AM Upgrade installed - version 1435813200480
I 10/01/16 11:06AM CrashPlan stopped, version 4.7.0, GUID 674279968953860117
</pre>
<p>Since around v4.7.0 CrashPlan switch to delivering the upgrades archive packages that can be extracted via the cpio utility.  The upgrade comes as an upgrade.cpi file.  First this needs to be unzipped, then the cpio utility can extract the contents.  Once compete the upgrade file should be removed so that it doesn't attempt to apply the upgrade when the service next starts</p>
<pre><code class="language-bash">cd /var/packages/CrashPlan/target
mv ./upgrade.cpi upgrade.cpi.gz
gunzip upgrade.cpi.gz
bin/cpio -i &lt; upgrade.cpi
rm upgrade.cpi
</code></pre>
<p>Should be able to start the service now</p>
<p>The comments of this (blog post)[https://pcloadletter.co.uk/2012/01/30/crashplan-syno-package/comment-page-42/#comments] seem to get updated as new problems are hit with versions</p>
<p>This (post)[https://crashplan.setepontos.com/crashplan-4-7-0-installation/] specifically talks about v4.7.0</p>
<h2 id="repairing-upgrade-4.7.0">Repairing upgrade &lt;4.7.0</h2>
<p>CrashPlan package fails to start on the synology. Viewing the log file from within the package manager shows something like</p>
<pre>
I 05/14/15 08:19PM Upgrades available at central.crashplan.com:443
I 05/14/15 08:19PM Downloading a new version of CrashPlan.
I 05/14/15 08:19PM Download of upgrade complete - version 1425276000420.
I 05/14/15 08:19PM Installing upgrade - version 1425276000420
I 05/14/15 08:20PM Upgrade installed - version 1425276000420
I 05/14/15 08:20PM CrashPlan stopped, version 3.7.0, GUID 674279968953860117
I 05/14/15 10:46PM Synology repairing upgrade in /var/packages/CrashPlan/target/upgrade/1425276000420.1431634799825
I 05/14/15 10:54PM Synology repairing upgrade in /var/packages/CrashPlan/target/upgrade/1425276000420.1431634799825
I 05/16/15 11:32AM Synology repairing upgrade in /var/packages/CrashPlan/target/upgrade/1425276000420.1431634799825
</pre>
<p>This seemed to happen after the upgrade to DSM 5.2.</p>
<p>Instructions to fix are <a href="http://chrisnelson.ca/2015/01/10/fixing-crashplan-on-synology-after-the-3-7-0-update-synology-repairing-upgrade-in-varpackagescrashplantargetupgrade1388728800370/">here</a></p>
<p>These instructions were for a different update version than above but the same principles apply</p>
<p>CrashPlan update appears to be a jar file that will be stored in /var/packages/CrashPlan/target/upgrade. Opening that in 7zip shows the files that make up the upgrade - this will likely be some jar files other directories e.g. localisation files, ui theme upgrades etc and an upgrade.sh script. The upgrade.sh script appears to be shared across releases and looks to see if the upgrade contains folders/files and moves them if they exist into the installed locaiton. As a result it refrences some paths that don't exist. One of the main problems it has on synology is that the normal daemon processes don't exist so it can't find/start them.</p>
<p>Essence of the upgrade is to copy jar files into ../../lib, if the upgrade script has run multiple times it will have moved jar files from the upgrade directory and they may have been deleted in subsequent runs (e.g. com<em>42</em>.jar files in the script looked at). View the upgrade.sh file to see all the steps carried out</p>
<p>Had issues using the unzip command to extract and copy the files directly to the install location, so choose to unzip into a temporary directory and manually copy the files. General gist of the commands are</p>
<pre><code class="language-bash">unzip -o /var/packages/CrashPlan/target/upgrade/1388728800370.jar *.jar -d /var/packages/CrashPlan/target/lib/
unzip -o /var/packages/CrashPlan/target/upgrade/1388728800370.jar run.conf -d /var/packages/CrashPlan/target/bin/
unzip -o /var/packages/CrashPlan/target/upgrade/1388728800370.jar lang/* -d /var/packages/CrashPlan/target/
ls -l /var/packages/CrashPlan/target/upgrade/1388728800370.*
mv /var/packages/CrashPlan/target/upgrade/1388728800370.whatevervalue/upgrade.sh /var/packages/CrashPlan/target/upgrade/1388728800370.whatevervalue/upgrade.sh.old
</code></pre>
<p>or my version</p>
<pre><code class="language-bash">cd /var/packages/CrashPlan/target/upgrade/
mkdir tmp
cp 1425276000420.jar tmp
cd tmp
unzip 1425276000420.jar
cp *.jar ../../lib
rm ../../lib/1425276000420.jar
cd ..
rm -r tmp/
1425276000420.1431634799825/
mv upgrade.sh upgrade.sh.old
</code></pre>
<p>Should now be able to start the package again from the package manager</p>
<pre><code class="language-bash">tail -f /var/packages/CrashPlan/target/log/history.log.0
</code></pre>
<h2 id="starts-then-stops-immediately">Starts then stops immediately</h2>
<p>Viewing the log from the package manager shows that the service starts and then stops immediately not reporting any more information</p>
<pre>
I 01/04/16 08:17PM CrashPlan started, version 4.5.0, GUID 674279968953860117
I 01/04/16 08:17PM CrashPlan stopped, version 4.5.0, GUID 674279968953860117
</pre>
<p>Note this log file can be found at /var/packages/CrashPlan/target/log/history.log.0</p>
<p>To find more detailed information you need to check the other logs also found at /var/packages/CrashPlan/target/log. In this scenario the log that had the most useful information was service.log.0</p>
<pre>
[01.04.16 20:17:16.731 ERROR main         ackup42.service.ui.UIInfoUtility] Missing an expected field in the .ui_info file; continuing, it will be recreated.
[01.04.16 20:17:16.734 ERROR main           com.backup42.service.CPService] Error starting up, java.lang.NumberFormatException: For input string: ""
STACKTRACE:: java.lang.NumberFormatException: For input string: ""
	at java.lang.NumberFormatException.forInputString(NumberFormatException.java:65)
	at java.lang.Integer.parseInt(Integer.java:504)
	at java.lang.Integer.parseInt(Integer.java:527)
	at com.backup42.service.ui.UIInfoUtility$UIConnectionDetailsResult.getPort(UIInfoUtility.java:179)
	at com.backup42.service.ui.UIInfoUtility.hasUIConnectionDetails(UIInfoUtility.java:139)
	at com.backup42.service.CPService.writeUIInfoFile(CPService.java:1327)
	at com.backup42.service.CPService.start(CPService.java:612)
	at com.backup42.service.CPService.main(CPService.java:2239)
...
</pre>
<p>Suggested an issue in the ui_info configration file. This is stored at /var/lib/crashplan/.ui_info. Looking at the file it was empty. The log suggests that it would be recreated but that wasn't happening. Delete the empty file and try starting the service again. This should generate a new file from scratch and allow the service to start running again. Note you will need to update the ui_info configuration file on your windows boxes to use this new GUID to connect to the headless service.</p>

        </div>
        <div class="col-md-3">
            <nav id="toc" data-toggle="toc" data-spy="affix"></nav>
        </div>
    </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="text-muted">Craig Paton</p>
  </div>
</footer>

</body>
<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="/js/jquery-3.1.0.min.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="/js/bootstrap.min.js"></script>

<script src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script src="/js/bootstrap-toc.min.js"></script>

<script lang="javascript">
(function($){
    $(document).ready(function(){
        $('ul.dropdown-menu [data-toggle=dropdown]').on('click', function(event) {
            event.preventDefault(); 
            event.stopPropagation(); 
            $(this).parent().siblings().removeClass('open');
            $(this).parent().toggleClass('open');
        });
    });
})(jQuery);
</script>

<script lang="javascript">
$('body').scrollspy({ 
    target: '#toc', offset: 55
})
</script>

<script src="/js/anchor-fix.js"></script>

<!-- style all markdown tables -->
<script lang="javascript">
(function($){
    $(document).ready(function(){
        $('table').addClass("table table-bordered table-hover")
    });
})(jQuery);
</script>

<!-- show horizontal scrollbar for code blocks instead of wrapping -->
<!--<script lang="javascript">
(function($){
    $(document).ready(function(){
        $('pre code').css({ 
            "overflow-x": "auto",
            "white-space": "pre"
        })
    });
})(jQuery);
</script>-->
</html>