<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Passwords</title>
    <!--  -->
    <link rel="canonical" href="https://nb.craigpaton.uk/development/powershell/passwords.html" />
    <!--<link rel="stylesheet" type="text/css" href="/css/bootstrap.css" media="screen">-->
    <link rel="stylesheet" type="text/css" href="/css/bootstrap-solar.min.css" media="screen">
    <link rel="stylesheet" type="text/css" href="/css/bootstrap-toc.min.css" media="screen">
    <link rel="stylesheet" type="text/css" href="/css/rainbow.css" media="screen">
    <link rel="stylesheet" type="text/css" href="/css/customisation.css" media="screen">
</head>
<body data-spy="scroll" data-target="#toc">
    
    <nav id="header-nav-bar" class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">Notebook</a>
            </div>
            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">cloud <span class="caret"></span></a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/cloud/network.html">Networks</a></li>
                            </ul>
                            <!-- NavBarMenu End -->
                    </li>
                </ul>
                <ul class="nav navbar-nav">
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">development <span class="caret"></span></a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">architecture</a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/development/architecture/CQRS.html">CQRS</a></li>
                            <li class=""><a href="/development/architecture/DDD.html">DDD</a></li>
                            <li class=""><a href="/development/architecture/event-sourcing.html">Event Sourcing</a></li>
                            <li class=""><a href="/development/architecture/microservices.html">Microservices</a></li>
                            <li class=""><a href="/development/architecture/resources.html">Resources</a></li>
                            </ul>
                            <!-- NavBarMenu End --> 
                            </li>   
                            <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">bash</a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/development/bash/snippets.html">Snippets</a></li>
                            </ul>
                            <!-- NavBarMenu End --> 
                            </li>   
                            <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">computer-science</a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/development/computer-science/compilers-and-interpreters.html">Compilers &amp; Interpreters</a></li>
                            <li class=""><a href="/development/computer-science/os.html">OS</a></li>
                            </ul>
                            <!-- NavBarMenu End --> 
                            </li>   
                            <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">delivery</a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/development/delivery/continuous-integration.html">CI</a></li>
                            </ul>
                            <!-- NavBarMenu End --> 
                            </li>   
                            <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">dotnet</a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/development/dotnet/fsharp.html">F#</a></li>
                            <li class=""><a href="/development/dotnet/gc.html">GC</a></li>
                            </ul>
                            <!-- NavBarMenu End --> 
                            </li>   
                            <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">git</a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/development/git/snippets.html">Snippets</a></li>
                            <li class=""><a href="/development/git/ssh-key-per-host.html">SSH Key Per Host</a></li>
                            <li class=""><a href="/development/git/ssh-keys.html">SSH Key Generation</a></li>
                            </ul>
                            <!-- NavBarMenu End --> 
                            </li>   
                            <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">github</a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/development/github/actions.html">GitHub Actions</a></li>
                            </ul>
                            <!-- NavBarMenu End --> 
                            </li>   
                            <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">powershell</a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/development/powershell/dynamic-functions.html">Dynamic Functions</a></li>
                            <li class=""><a href="/development/powershell/passwords.html">Passwords</a></li>
                            <li class=""><a href="/development/powershell/publishing-modules.html">Publising Modules</a></li>
                            <li class=""><a href="/development/powershell/updating-modules.html">Updating Modules</a></li>
                            </ul>
                            <!-- NavBarMenu End --> 
                            </li>   
                            <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">process</a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/development/process/dev-ops.html">DevOps</a></li>
                            <li class=""><a href="/development/process/kanban.html">Kanban</a></li>
                            <li class=""><a href="/development/process/ToC.html">Theory of Constraints</a></li>
                            </ul>
                            <!-- NavBarMenu End --> 
                            </li>   
                            <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">python</a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/development/python/getting-started.html">Getting Started</a></li>
                            </ul>
                            <!-- NavBarMenu End --> 
                            </li>   
                            <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">testing</a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/development/testing/BDD.html">BDD</a></li>
                            <li class=""><a href="/development/testing/current-thinking.html">Current thinking</a></li>
                            <li class=""><a href="/development/testing/resources.html">Resources</a></li>
                            </ul>
                            <!-- NavBarMenu End --> 
                            </li>   
                            <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">tooling</a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/development/tooling/tfs.html">TFS</a></li>
                            </ul>
                            <!-- NavBarMenu End --> 
                            </li>   
                            <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">web</a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/development/web/angular.html">Angular 2</a></li>
                            <li class=""><a href="/development/web/css.html">CSS</a></li>
                            <li class=""><a href="/development/web/npm.html">NPM</a></li>
                            <li class=""><a href="/development/web/resources.html">Resources</a></li>
                            </ul>
                            <!-- NavBarMenu End --> 
                            </li>   
                            </ul>
                            <!-- NavBarMenu End -->
                    </li>
                </ul>
                <ul class="nav navbar-nav">
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">finance <span class="caret"></span></a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/finance/options.html">Options</a></li>
                            </ul>
                            <!-- NavBarMenu End -->
                    </li>
                </ul>
                <ul class="nav navbar-nav">
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">hardware <span class="caret"></span></a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/hardware/network-speed.html">Network Speed</a></li>
                            <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">raspberry-pi</a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/hardware/raspberry-pi/sd-cards.html">SD Cards</a></li>
                            </ul>
                            <!-- NavBarMenu End --> 
                            </li>   
                            <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">synology</a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/hardware/synology/crash-plan.html">CrashPlan</a></li>
                            <li class=""><a href="/hardware/synology/git.html">Git Backup</a></li>
                            <li class=""><a href="/hardware/synology/gmvault.html">GMail Backup (GMVault)</a></li>
                            <li class=""><a href="/hardware/synology/notifications.html">Notifications</a></li>
                            <li class=""><a href="/hardware/synology/plex.html">Plex</a></li>
                            <li class=""><a href="/hardware/synology/restore.html">Restore Plan</a></li>
                            <li class=""><a href="/hardware/synology/ssh.html">SSH</a></li>
                            <li class=""><a href="/hardware/synology/vpn.html">VPN</a></li>
                            </ul>
                            <!-- NavBarMenu End --> 
                            </li>   
                            <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">unifi</a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/hardware/unifi/vpn.html">VPN</a></li>
                            </ul>
                            <!-- NavBarMenu End --> 
                            </li>   
                            </ul>
                            <!-- NavBarMenu End -->
                    </li>
                </ul>
                <ul class="nav navbar-nav">
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">misc <span class="caret"></span></a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/misc/blockchain.html">Blockchain</a></li>
                            <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">learning</a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/misc/learning/resources.html">Resources</a></li>
                            </ul>
                            <!-- NavBarMenu End --> 
                            </li>   
                            <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">utility</a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/misc/utility/video.html">Video</a></li>
                            </ul>
                            <!-- NavBarMenu End --> 
                            </li>   
                            </ul>
                            <!-- NavBarMenu End -->
                    </li>
                </ul>
                <ul class="nav navbar-nav">
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">ops <span class="caret"></span></a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">docker</a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/ops/docker/cheat-sheet.html">Cheat Sheet</a></li>
                            <li class=""><a href="/ops/docker/map-custom_folder-to-host.html">Map Custom Folder</a></li>
                            <li class=""><a href="/ops/docker/on-windows.html">Docker On Windows</a></li>
                            </ul>
                            <!-- NavBarMenu End --> 
                            </li>   
                            <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">linux</a>
                                                        <!-- NavBarMenu Start -->
                            <ul class="dropdown-menu">
                            <li class=""><a href="/ops/linux/arch-linux.html">Arch Linux Install</a></li>
                            </ul>
                            <!-- NavBarMenu End --> 
                            </li>   
                            <li class=""><a href="/ops/machine-bootsrap.html">Machine Bootstrap</a></li>
                            <li class=""><a href="/ops/resources.html">Resources</a></li>
                            </ul>
                            <!-- NavBarMenu End -->
                    </li>
                </ul>
            </div>
        </div>
    </nav>

<div class="container">

    <div class="row">
        <div class="col-md-9">
            <h1>Passwords</h1>
            <hr />
        <h1 id="requesting-credentials">Requesting credentials</h1>
<p>PowerShell has built in support for credentials based on a username and password.  To display a prompt to the user to allow them to enter a username and password use</p>
<pre><code class="language-powershell">Get-Credential -Message &quot;Custom message to display to the user&quot; -UserName UserName
</code></pre>
<p>This will return a <strong>PSCredential</strong> object with the password stored as a secure string</p>
<h1 id="storing-credentials">Storing credentials</h1>
<h2 id="in-a-file">In a file</h2>
<p>PowerShell supports converting a SecureString into a regular string in encrypted form.  The Windows Data Protected APIs (DPAPI) is used to ensure that only the current user is able to get the password in plain text.  Once you have the credential object use <strong>Convert-FromSecureString</strong> to get a string suitable for storage</p>
<pre><code class="language-powershell"># Prompt the user for their credentials
$credentialType = &quot;storage sample&quot;
$credential = Get-Credential -Message $credentialType -UserName $env:UserName

# Store the credentials in encrypted form within their user profile
$encryptedPassword = ConvertFrom-SecureString -SecureString $credential.Password
$storedCredentialPath = Join-Path -Path $env:APPDATA -ChildPath &quot;Credentials&quot;
if ( -not ( Test-Path $storedCredentialPath ) ) {
    New-Item -Path $storedCredentialPath -ItemType Directory | Out-Null
}
$credentialFileName = Join-Path -Path $storedCredentialPath -ChildPath ( &quot;{0}.dat&quot; -f $credentialType )
Set-Content -Path $credentialFileName -Value &#64;( $credential.UserName, $encryptedPassword )

# Read the password back into a credential object
$storedCredential = Get-Content -Path $credentialFileName
$userName = $storedCredential[0]
$securePassword = ConvertTo-SecureString -String $storedCredential[1]
$retrievedCredential = New-Object -TypeName PSCredential -ArgumentList $userName, $securePassword
</code></pre>
<h2 id="windows-credential-manager">Windows credential manager</h2>
<p>PowerShell gallery has a module <strong>CredentialManager</strong> which can be used to interact with the Windows credential manager for secure storage of credentials.  Install the module via</p>
<pre><code class="language-powershell">Install-Module -Name CredentialManager -Scope CurrentUser
</code></pre>
<p>Then store credentials by</p>
<pre><code class="language-powershell">Import-Module CredentialManager

# Prompt the user for their credentials
$credentialType = &quot;storage sample&quot;
$credential = Get-Credential -Message $credentialType -UserName $env:UserName

New-StoredCredential -Type Generic -Target &quot;Name to show in credential manager&quot; -Credentials $credential -Persist LocalMachine 
</code></pre>
<h1 id="passing-a-password-from-powershell-to-c">Passing a password from PowerShell to C#</h1>
<p>Extract the password from the secure string on the PSCredential and use the DPAPI to encrypt and base64 encode the result to send it over to C#</p>
<pre><code class="language-powershell">function ConvertTo-EncryptedBase64 {
    &lt;#
        .Synopsis
            Converts a secure string into a encrypted base64 string which can be passed into other tools e.g. a C# progream

        .Description
            Used to provide a way to accept credentials from a user in a PowerShell session and pass them to other programs without the password appearing in plain text at any point.  It will exist as plain text in memory for a short period of time while the conversion is taking place
    #&gt;
    [CmdletBinding()]
    param (
        # Secure string whose value is to be encrypted using the DPAPI and converted to a base64 encoded string
        [ValidateNotNull()]
        [System.Security.SecureString]
        $SecureString
    )

    $secureStringContents = [System.Runtime.InteropServices.Marshal]::SecureStringToCoTaskMemUnicode($SecureString);
    $secureStringBytes = New-Object -TypeName byte[] ( $SecureString.Length * 2 )
    try
    {
        [System.Runtime.InteropServices.Marshal]::Copy($secureStringContents, $secureStringBytes, 0, $secureStringBytes.Length)

        try {
            $protectedBytes = [System.Security.Cryptography.ProtectedData]::Protect($secureStringBytes, $null, [System.Security.Cryptography.DataProtectionScope]::CurrentUser)
        }
        finally {
            # 0 out the plain text password password in managed memory
            [Array]::Clear($secureStringBytes, 0, $secureStringBytes.Length);
        }
    }
    finally
    {
        # 0 and remove the password from unmanaged memory
        [System.Runtime.InteropServices.Marshal]::ZeroFreeCoTaskMemUnicode($secureStringContents)
    }

    [System.Convert]::ToBase64String($protectedBytes);
}

$cred = Get-Credential -Message &quot;password passing example&quot; -UserName $env:USERNAME
ConvertTo-EncryptedBase64 -SecureString $cred.Password
</code></pre>
<p>On the C# side reverse the process, convert the base64 string into bytes and decrypt.  Then construct the securestring one character at a time</p>
<pre><code class="language-c#">public static SecureString SecureStringFromEncryptedBase64String(string encryptedBase64String)
{
    var encryptedBytes = Convert.FromBase64String(encryptedBase64String);
    var unprotectedBytes = ProtectedData.Unprotect(encryptedBytes, null, DataProtectionScope.CurrentUser);

    var secureString = new SecureString();

    try
    {
        // characters in C# are unicode and so take up two bytes.  Take the decrypted bytes in pairs
        // and convert into a character and add to the secure string
        var num = unprotectedBytes.Length / 2;
        for (var index = 0; index &lt; num; ++index)
        {
            var c = (char)((uint)unprotectedBytes[2 * index + 1] * 256U + (uint)unprotectedBytes[2 * index]);
            secureString.AppendChar(c);
        }
    }
    finally
    {
        // Make sure to remove the unencrypted password from memory as soon as we are done
        Array.Clear(unprotectedBytes, 0, unprotectedBytes.Length);
    }

    return secureString;
}
</code></pre>

        </div>
        <div class="col-md-3">
            <nav id="toc" data-toggle="toc" data-spy="affix"></nav>
        </div>
    </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="text-muted">Craig Paton</p>
  </div>
</footer>

</body>
<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="/js/jquery-3.1.0.min.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="/js/bootstrap.min.js"></script>

<script src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script src="/js/bootstrap-toc.min.js"></script>

<script lang="javascript">
(function($){
    $(document).ready(function(){
        $('ul.dropdown-menu [data-toggle=dropdown]').on('click', function(event) {
            event.preventDefault(); 
            event.stopPropagation(); 
            $(this).parent().siblings().removeClass('open');
            $(this).parent().toggleClass('open');
        });
    });
})(jQuery);
</script>

<script lang="javascript">
$('body').scrollspy({ 
    target: '#toc', offset: 55
})
</script>

<script src="/js/anchor-fix.js"></script>

<!-- style all markdown tables -->
<script lang="javascript">
(function($){
    $(document).ready(function(){
        $('table').addClass("table table-bordered table-hover")
    });
})(jQuery);
</script>

<!-- show horizontal scrollbar for code blocks instead of wrapping -->
<!--<script lang="javascript">
(function($){
    $(document).ready(function(){
        $('pre code').css({ 
            "overflow-x": "auto",
            "white-space": "pre"
        })
    });
})(jQuery);
</script>-->
</html>